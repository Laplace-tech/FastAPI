<!-- docs/concepts/02-authn-authz-http-status.md -->
# 인증/권한과 HTTP 상태코드 정책 (DocuMind 기준)

## 1) 인증 vs 권한
- 인증(Authentication): “너 누구냐?” → 토큰이 유효한가, 사용자 식별 가능한가
- 권한(Authorization): “너 이거 해도 되냐?” → 이 문서가 네 것이냐, 역할이 맞냐

이 둘이 섞이면 API가 금방 난장판이 된다. 정책을 고정해두면 이후 개발이 빨라진다.

---

## 2) 상태코드 운영 정책(권장)
### 401 Unauthorized
다음 중 하나면 401:
- 토큰이 없음
- 토큰 형식이 이상함(Bearer 누락 등)
- 서명 검증 실패(위조)
- exp 만료
- 사용자 없음(탈퇴/삭제)
- token_version 불일치(로그아웃된 토큰)

> 원칙: “인증 자체가 실패”면 401

### 403 Forbidden
- 인증은 됐는데, 이 리소스에 접근 권한이 없음
- 예: 다른 사람 문서 조회/수정 시도

> 원칙: “너는 누구인지 알겠는데, 이건 네가 하면 안 됨”이면 403

### 404 Not Found (보안적 선택)
일부 서비스는 “리소스 존재 자체를 숨기기 위해” 403 대신 404를 쓰기도 한다.
- 장점: 리소스 유무를 공격자에게 덜 노출
- 단점: 디버깅이 어려워질 수 있음

DocuMind에서는 포트폴리오/학습 목적상:
- 내부 규칙은 403을 쓰되,
- “타인의 문서 ID 추측”을 막고 싶으면 404로 숨기는 정책을 채택할 수 있다.

---

## 3) 권한 체크의 기본 패턴(문서 API)
문서 리소스는 최소 아래 규칙을 고정한다:
- `document.owner_id == current_user.id` 아니면 차단
- admin role이 있으면 예외 허용(선택)

실무적으로 중요한 점:
- 권한 체크는 “토큰 클레임”만 믿지 말고 DB의 owner_id로 확인한다.
- 토큰의 role은 보조 정보로만 쓰는 게 안전하다(권한 변경이 즉시 반영되게).

---

## 4) 에러 바디(응답 포맷) 통일
실무에서 중요한 건 “클라이언트가 에러를 안정적으로 처리”하는 것.

권장 포맷 예시:
- `code`: 머신이 읽는 에러 코드
- `message`: 사람용 메시지
- `request_id`: 로그 추적용

예:
{
  "code": "AUTH_INVALID_TOKEN",
  "message": "Invalid or expired token",
  "request_id": "..."
}

---

## 5) DocuMind에 적용(정리)
- 인증 실패 → 401
- 다른 사람 문서 접근 → 403 또는 404(정책 선택)
- 내부 에러(예외) → 500 + request_id로 추적
